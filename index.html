<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        myDapp
    </title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" src="./dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberDriverABI.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberContract_ABI.js"></script>
    <script language="javascript" type="text/javascript" src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/dist/site.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">Uber App</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="#RequestRideDiv" data-toggle="tab">Request Ride</a>
                    </li>
                    <li>
                        <a href="#ridesDiv" data-toggle="tab">Ride</a>
                    </li>
                    <li>
                        <a href="#ridesListDiv" data-toggle="tab">List Of Rides</a>
                    </li>
                    <li>
                        <a href="#contact" data-toggle="tab">Become a Rider</a>
                    </li>
                    <li>
                        <a id="adminNav" href="#adminTab" data-toggle="tab">Admin</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="tab-content">
        <div id="RequestRideDiv" class="tab-pane fade blocks  in active">
            <div class="container">
                <div class="col-md-8">
                    <h3>Request Ride</h3>
                    </br>
                    <div id="accountAddress"></div>
                    <div id="addDriversDiv">
                        <lablel>Driver</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDriver">
                        </br>
                        <lablel>Pick Up</lablel>
                        </br>
                        <input type="text" class="form-control" id="addPickUp">
                        </br>
                        <lablel>Drop Off</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDropOff">
                        </br>
                        <lablel>Distance</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDistance">
                        </br>
                        <p id="rideFee"></p>
                        <br>
                        <div id="txStatus"></div>
                        </br>
                        <button type="button" class="btn btn-default" onclick="requestRide()">Request Ride</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div>
                        <h3>Drivers to Select From</h3>
                    </div>
                    <div id="drivers"></div>
                    <br>


                </div>
            </div>
        </div>
        <div id="ridesDiv" class="tab-pane fade blocks">
            <div class="container">
                <div class="col-md-8">
                    <br>
                    <h4>Current Ride</h4>
                    <div id="currentRideDiv">

                    </div>
                    <div id="actionsDiv">

                    </div>
                </div>
            </div>
        </div>
        <div id="ridesListDiv" class="tab-pane fade blocks">
            <div class="container">

                <div class="col-md-8">
                    <h4>Number of Rides</h4>
                    <div id="rideCount">
                    </div>
                    <h3>Rides</h3>
                    <div id="getAllRides">
                    </div>
                </div>
            </div>
        </div>
        <div id="adminTab" class="tab-pane fade blocks" style=>
            <div class="container">

                <div class="col-md-8">
                    <br>
                    <h4>Update Fee Per KM</h4>
                    </br>
                    <p id="rideFee2"></p>
                    <input type="text" class="form-control" id="addNewFee">
                    <br>
                    <button type="button" class="btn btn-default" onclick="updateFeePerKM()">Update Fee Per KM</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script>
    var uberDrivers;
    var userAccount;
    var uberContract;
    var alllRideEvent;
    var owner;
    //    var MyContract = web3.eth.contract(uberDriversABI);
    var MyUberContract = web3.eth.contract(uberContractABI);
    uberContract = MyUberContract.at('0x345ca3e014aaf5dca488057592ee47305d9b3e10');
    var alllRideEvent = uberContract.RideEvent();
    var feeUpdateEvent = uberContract.FeeUpdated();

    function checkUserAccount() {
        var accountInterval = setInterval(function () {
            // Check if account has changed
            if (web3.eth.accounts[0] !== userAccount) {
                userAccount = web3.eth.accounts[0];
                $("#accountAddress").html("Your account: " + userAccount);
                callRideEvent();
                adminActions();
            }
        }, 100);
    }
    function startApp() {


        checkOwner();
        checkUserAccount();
        adminActions();
        getAllDriver();
        getAllRides();
        adminActions();
        checkFeePerKM();

    }

    function checkFeePerKM() {
        uberContract.feePerKM(function (err, res) {
            if (!err) {
                var feePerKM = web3.fromWei(res, 'ether');
                $("#rideFee").empty();
                $("#rideFee2").empty();
                $("#rideFee").append(`Ride Fee: ` + feePerKM + ` ether`);
                $("#rideFee2").append(`Ride Fee: ` + feePerKM + ` ether`);
            } else {
                console.log(err);
            }
        })
    }

    function checkOwner() {
        uberContract.owner(function (err, res) {
            if (!err) {
                owner = res;
            } else {
                console.log(err);
            }
        });
    }

    function adminActions() {
        if (userAccount != owner) {
            $("#adminTab").hide();
            $("#adminNav").hide();
        } else if (userAccount == owner) {
            $("#adminTab").show();
            $("#adminNav").show();
        }
        else {
            $("#adminTab").hide();
            $("#adminNav").hide();
        }
    }
    var listOfDrivers;

    function getAllDriver() {
        $("#drivers").empty();
        uberContract.getAllDriver(function (err, res) {
            if (!err) {
                listOfDrivers = res;
            } else {
                console.log(err);
            }

            var numDrivers = listOfDrivers.length;
            for (var i = 0; i < numDrivers; i++) {
                var addressVal = web3.toBigNumber(listOfDrivers[i]);
                $("#drivers").append("<div id='driver" + i + "'class='driver' onclick='fillDriver(" + i + ")'>" + listOfDrivers[i] + " </div>");
            }
        });
    }

    function getAllRides() {
        var ridecount;
        $("#rideCount").empty();
        uberContract.getRideCount(function (err, res) {
            if (!err) {
                ridecount = res;
                $("#rideCount").append("<div id='rideCount2'>" + ridecount + " </div>");
                for (var i = 0; i < ridecount; i++) {
                    var k = i + 1;
                    uberContract.getRide(k, function (err, res) {
                        if (!err) {
                            console.log(res);
                            var rideValue2 = web3.fromWei(res[5], 'ether');
                            var status = getStatus(res[6]);

                            $("#getAllRides").append(`<div class="panel-group">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#collapse` + res[0] + `"> Ride` + res[0] + `</a>
                                    </h4>
                            </div>
                            <div id="collapse` + res[0] + `" class="panel-collapse collapse">
                                <div id="panel` + res[0] + `" class="panel-body">
                                    <ul>
                                        <li>Ride Id: ` + res[0] + `</li>
                                        <li>Driver Address: ` + res[1] + `</li>
                                        <li>Rider Address: ` + res[2] + `</li>
                                        <li>Pick Up Address: ` + res[3] + `</li>
                                        <li>Drop off Address: ` + res[4] + `</li>
                                        <li>Ride Value: ` + rideValue2 + ` ether</li>
                                        <li>Ride Status: ` + status + `</li>
                                    </ul>
                                </div>
                            </div>
                            </div>
                            </div>`);
                            if (status == "Requested") {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="payForRide(` + res[0] + `, ` + rideValue2 + `)">Pay for ride</button>`)
                            } else if (status == "Paid" && userAccount == res[1]) {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="startRide(` + res[0] + `)">Start Ride</button>`)
                            }
                            else if ((status == "InProgress") && (userAccount == res[2] || userAccount == res[1])) {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="completeRide(` + res[0] + `)">Complete</button>`)
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="cancelRide(` + res[0] + `)">Cancel</button>`)
                            }
                        } else {
                            console.log(err);
                        }
                    });
                }
            } else {
                console.log(err);
            }
        });
    }

    var rideID;
    var rideValue;
    function requestRide() {
        var driver = listOfDrivers[selectedDriver];
        var pickup = $("#addPickUp").val();
        var dropOff = $("#addDropOff").val();
        var distance = $("#addDistance").val();

        uberContract.requestRide(driver, pickup, dropOff, distance, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });



    }

    function getStatus(id) {
        var status;
        if (id == 0) {
            status = "NotStarted";
        } else if (id == 1) {
            status = "Requested";
        } else if (id == 2) {
            status = "Paid";
        } else if (id == 3) {
            status = "InProgress";
        } else if (id == 4) {
            status = "Completed";
        } else if (id == 5) {
            status = "Cancelled";
        }
        return status;
    }

    function payForRide(id, value) {
        var weiValue = web3.toWei(web3.toBigNumber(value), 'ether');
        uberContract.payForRide(id, { value: weiValue }, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });
    }

    function updateFeePerKM() {
        var newFee = $("#addNewFee").val();
        var weiVal = web3.toWei(newFee, 'ether');
        uberContract.setRideFee(weiVal, function (err, res) {
            if (!err) {
                console.log(res);
            } else
                console.log(err);
        });
    }

    function startRide(id) {
        uberContract.startRide(id, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });
    }

    function completeRide(id) {
        uberContract.completeRide(id, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });
    }
    var selectedDriver;
    function fillDriver(id) {
        selectedDriver = id;
        $("#addDriver").val(listOfDrivers[id]);
    }
    window.addEventListener('load', function () {

        if (typeof web3 !== 'undefined') {
            web3js = new Web3(web3.currentProvider);
        } else {

        }
        startApp()

    })
    function checkActionStatus(statusActive, rider, driver, rideIDActive, rideValue, dComplete, rComplete) {

        var acc = web3.eth.accounts[0];
        if (statusActive == "Requested" && acc == rider) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`
                    <button  type="button" class="btn btn-default" onclick="payForRide(` + rideIDActive + `, ` + rideValue + `)">Pay for ride</button>`)
        } else if (statusActive == "Requested" && acc == driver) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Waiting for rider to pay for ride`);
        } else if (statusActive == "Paid" && acc == rider) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Ride has been paid for, waiting for driver to start drive`);
        } else if (statusActive == "Paid" && acc == driver) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<button  type="button" class="btn btn-default" onclick="startRide(` + rideIDActive + `)">Start Ride</button>`);
        } else if (statusActive == "InProgress" && acc == driver && !dComplete && !rComplete) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Rider has not completed yet</p>`);
            $("#actionsDiv").append(`<button  type="button" class="btn btn-default" onclick="completeRide(` + rideIDActive + `)">Driver Complete</button>`);
        } else if (statusActive == "InProgress" && acc == driver && dComplete && !rComplete) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p>Driver has completed ride but rider has not completed yet</p>`);
        } else if (statusActive == "InProgress" && acc == driver && !dComplete && rComplete) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Rider has completed ride</p>`);
            $("#actionsDiv").append(`<button  type="button" class="btn btn-default" onclick="completeRide(` + rideIDActive + `)">Driver Complete</button>`);
        }
        else if (statusActive == "InProgress" && acc == rider && !dComplete && !rComplete) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Driver has not completed yet</p>`);
            $("#actionsDiv").append(`<button  type="button" class="btn btn-default" onclick="completeRide(` + rideIDActive + `)">Rider Complete</button>`);
        } else if (statusActive == "InProgress" && acc == rider && dComplete && !rComplete) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Driver has completed ride</p>`);
            $("#actionsDiv").append(`<button  type="button" class="btn btn-default" onclick="completeRide(` + rideIDActive + `)">Rider Complete</button>`);
        }
        else if (statusActive == "Completed") {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Ride has been completed </p>`);
        } else if (acc != rider && acc != driver) {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> You do not have access to change the state of the ride`);
        }

        else {
            $("#actionsDiv").empty();
            $("#actionsDiv").append(`<p> Unknown State <p/>`);
        }
    }
    function callRideEvent() {
        alllRideEvent.watch(function (error, result) {
            if (!error) {
                var rideIDActive = result.args.rideId;
                var rideValueActive = web3.fromWei(result.args.rideValue, 'ether');
                var statusActive = getStatus(result.args.status);
                //            $("#RequestRideDiv").removeClass("active");
                //            $("#ridesDiv").addClass("active");
                $("#currentRideDiv").empty();
                $("#currentRideDiv").append(`<ul>
                                            <li id="rideid">Ride Id:` + rideIDActive.toString() + `</li>
                                            <li id="driveraddress">Driver Address: ` + result.args.driver + `</li>
                                            <li id="rideraddress">Rider Address: ` + result.args.rider + `</li>
                                            <li id="pickupaddress">Pick Up Address: ` + result.args.pickup + `</li>
                                            <li id="dropoffaddress">Drop off Address: ` + result.args.dropoff + `</li>
                                            <li id="ridevalDiv">Ride Value: ` + rideValueActive.toString() + ` ether</li>
                                            <li id="ridestatus">Ride Status: ` + statusActive + `</li>
                                        </ul>`);
                checkActionStatus(statusActive, result.args.rider, result.args.driver, rideIDActive, rideValueActive, result.args.CmD, result.args.CmR);

            } else {
                console.log(error);
            }
        });
    }

    feeUpdateEvent.watch(function (error, result) {
        if (!error) {
            var newFee = web3.fromWei(result.args.newFee, 'ether');
            $("#rideFee").empty();
            $("#rideFee2").empty();
            $("#rideFee").append(`Ride Fee: ` + newFee + ` ether`);
            $("#rideFee2").append(`Ride Fee: ` + newFee + ` ether`);

        } else {
            console.log(error);
        }
    })

</script>