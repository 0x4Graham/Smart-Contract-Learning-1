<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        myDapp
    </title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" src="./dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberDriverABI.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberContract_ABI.js"></script>
    <script language="javascript" type="text/javascript" src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/dist/site.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
                    aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Uber App</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="#">Request Ride</a>
                    </li>
                    <li>
                        <a href="#about">Ride</a>
                    </li>
                    <li>
                        <a href="#about">List Of Rides</a>
                    </li>
                    <li>
                        <a href="#contact">Become a Rider</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <div class="col-md-8">
            <h3>Request Ride</h3>
            </br>
            <div id="accountAddress"></div>
            <div id="addDriversDiv">
                <lablel>Driver</lablel>
                </br>
                <input type="text" class="form-control" id="addDriver">
                </br>
                <lablel>Pick Up</lablel>
                </br>
                <input type="text" class="form-control" id="addPickUp">
                </br>
                <lablel>Drop Off</lablel>
                </br>
                <input type="text" class="form-control" id="addDropOff">
                </br>
                <lablel>Distance</lablel>
                </br>
                <input type="text" class="form-control" id="addDistance">
                </br>
                <img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif">
                <br>
                <div id="txStatus"></div>
                </br>
                <button type="button" class="btn btn-default" onclick="requestRide()">Request Ride</button>
            </div>
        </div>
        <div class="col-md-4">
            <h3>Drivers to Select From</h3>
            <div id="drivers"></div>
            <br>
            <h4>Number of Rides</h4>
            <div id="rideCount">
            </div>
            <div id="getAllRides">

            </div>
        </div>

    </div>

</body>

</html>

<script>
    var uberDrivers;
    var userAccount;
    var uberContract;
    var requestRideEvent;
    //    var MyContract = web3.eth.contract(uberDriversABI);
    var MyUberContract = web3.eth.contract(uberContractABI);


    function startApp() {

        //uberDrivers = MyContract.at('0xf25186b5081ff5ce73482ad761db0eb0d25abfbf');
        uberContract = MyUberContract.at('0x345ca3e014aaf5dca488057592ee47305d9b3e10');

        //uberDrivers = new web3js.eth.contract(uberDriversABI).at(uberDriversAddress);
        //uberContract = new web3js.eth.contract(uberContractABI,uberContractAddress);
        //console.log(uberContract);
        var accountInterval = setInterval(function () {
            // Check if account has changed
            if (web3.eth.accounts[0] !== userAccount) {
                userAccount = web3.eth.accounts[0];
                $("#accountAddress").html("Your account: " + userAccount);
            }
        }, 100);
        getAllDriver();
        getAllRides();
        requestRideEvent = uberContract.RideCreation();

    }
    var listOfDrivers;

    function getAllDriver() {
        $("#drivers").empty();
        uberContract.getAllDriver(function (err, res) {
            if (!err) {
                listOfDrivers = res;
            } else {
                console.log(err);
            }

            var numDrivers = listOfDrivers.length;
            for (var i = 0; i < numDrivers; i++) {
                var addressVal = web3.toBigNumber(listOfDrivers[i]);
                $("#drivers").append("<div id='driver" + i + "'class='driver' onclick='fillDriver(" + i + ")'>" + listOfDrivers[i] + " </div>");
            }
        });
    }

    function getAllRides() {
        var ridecount;
        $("#rideCount").empty();
        uberContract.getRideCount(function (err, res) {
            if (!err) {
                ridecount = res;
                $("#rideCount").append("<div id='rideCount2'>" + ridecount + " </div>");
            } else {
                console.log(err);
            }
        });
        for (var i = 0; i < ridecount; i++) {
            uberContract.getRide(i, function (err, res) {
                if (!err) {
                    console.log(res);
                    // $("#drivers").append("<div id='rideCount2" + ">" + res + " </div>");

                } else {
                    console.log(err);
                }
            });
        }
    }
    function displayDrivers(ids) {
        $("#drivers").empty();
        for (id of ids) {
            getDriverDetails(id)
                .then(function (driver) {
                    $("#drivers").append(`<div class="driver">
              <ul>
                <li>Name: ${driver.name}</li>
                <li>Car: ${driver.car}</li>
                <li>Rating: ${driver.rating}</li>
                <li>Address: ${driver.address}</li>
              </ul>
            </div>`);
                })
        }
    }

    var rideID;
    var rideValue;
    function requestRide() {
        var driver = listOfDrivers[selectedDriver];
        var pickup = $("#addPickUp").val();
        var dropOff = $("#addDropOff").val();
        var distance = $("#addDistance").val();

        uberContract.requestRide(driver, pickup, dropOff, distance, function (err, res) {
            if (!error)
                console.log(result)
            else
                console.error(error);
        });

        requestRideEvent.watch(function (error, result) {
            if (!error) {
                $("#loader").hide();
                rideID = result.args.rideId;
                rideValue = web3.fromWei(result.args.rideValue, 'ether');
                $("#txStatus").html(result.args.rideId + ' (' + rideValue + ' ether)');             
            } else {
                $("#loader").hide();
                console.log(error);
            }
        });

    }

    function addDriver() {
        var _name = $("#addName").val();
        var _car = $("#addCar").val();

        //return uberDrivers.requestToBeDriver(drivercar, drivername)
        uberDrivers.requestToBeDriver(_car, _name, { gas: 100000000000, gas: 4712388 }, function (error, result) {
            if (!error)
                console.log(result)
            else
                console.error(error);
        });
    }

    function getDriverDetails(id) {
        return uberDrivers.methods.uberdrivers(id);
    }
    var selectedDriver;
    function fillDriver(id) {
        selectedDriver = id;
        $("#addDriver").val(listOfDrivers[id]);
    }
    window.addEventListener('load', function () {

        if (typeof web3 !== 'undefined') {
            web3js = new Web3(web3.currentProvider);
        } else {

        }
        startApp()
    })
</script>