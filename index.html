<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        myDapp
    </title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" src="./dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberDriverABI.js"></script>
    <script language="javascript" type="text/javascript" src="/Javascript/uberContract_ABI.js"></script>
    <script language="javascript" type="text/javascript" src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/dist/site.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">Uber App</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="#RequestRideDiv" data-toggle="tab">Request Ride</a>
                    </li>
                    <li>
                        <a href="#ridesDiv" data-toggle="tab">Ride</a>
                    </li>
                    <li>
                        <a href="#ridesListDiv" data-toggle="tab">List Of Rides</a>
                    </li>
                    <li>
                        <a href="#contact" data-toggle="tab">Become a Rider</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="tab-content">
        <div id="RequestRideDiv" class="tab-pane fade blocks  in active">
            <div class="container">
                <div class="col-md-8">
                    <h3>Request Ride</h3>
                    </br>
                    <div id="accountAddress"></div>
                    <div id="addDriversDiv">
                        <lablel>Driver</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDriver">
                        </br>
                        <lablel>Pick Up</lablel>
                        </br>
                        <input type="text" class="form-control" id="addPickUp">
                        </br>
                        <lablel>Drop Off</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDropOff">
                        </br>
                        <lablel>Distance</lablel>
                        </br>
                        <input type="text" class="form-control" id="addDistance">
                        </br>
                        <img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif">
                        <br>
                        <div id="txStatus"></div>
                        </br>
                        <button type="button" class="btn btn-default" onclick="requestRide()">Request Ride</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div>
                        <h3>Drivers to Select From</h3>
                    </div>
                    <div id="drivers"></div>
                    <br>


                </div>
            </div>
        </div>
        <div id="ridesDiv" class="tab-pane fade blocks">
            <div class="container">
                <div class="col-md-8">
                    <br>
                    <h4>Current Ride</h4>
                    <ul>
                        <li id="rideid">Ride Id:</li>
                        <li id="driveraddress">Driver Address: </li>
                        <li id="rideraddress">Rider Address:</li>
                        <li id="pickupaddress">Pick Up Address:</li>
                        <li id="dropoffaddress">Drop off Address:</li>
                        <li id="rideval">Ride Value</li>
                        <li id="ridestatus">Ride Status:</li>
                    </ul>
                    <div id="actions">

                    </div>
                </div>
            </div>
        </div>
        <div id="ridesListDiv" class="tab-pane fade blocks">
            <div class="container">

                <div class="col-md-8">
                    <h4>Number of Rides</h4>
                    <div id="rideCount">
                    </div>
                    <h3>Rides</h3>
                    <div id="getAllRides">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script>
    var uberDrivers;
    var userAccount;
    var uberContract;
    var requestRideEvent;
    //    var MyContract = web3.eth.contract(uberDriversABI);
    var MyUberContract = web3.eth.contract(uberContractABI);


    function startApp() {

        //uberDrivers = MyContract.at('0xf25186b5081ff5ce73482ad761db0eb0d25abfbf');
        uberContract = MyUberContract.at('0x345ca3e014aaf5dca488057592ee47305d9b3e10');
        requestRideEvent = uberContract.RideCreation();
        payRideEvent = uberContract.RidePaid();

        //uberDrivers = new web3js.eth.contract(uberDriversABI).at(uberDriversAddress);
        //uberContract = new web3js.eth.contract(uberContractABI,uberContractAddress);
        //console.log(uberContract);
        var accountInterval = setInterval(function () {
            // Check if account has changed
            if (web3.eth.accounts[0] !== userAccount) {
                userAccount = web3.eth.accounts[0];
                $("#accountAddress").html("Your account: " + userAccount); 
                events();               
            }
        }, 100);
        getAllDriver();
        getAllRides();
    }
    var listOfDrivers;

    function getAllDriver() {
        $("#drivers").empty();
        uberContract.getAllDriver(function (err, res) {
            if (!err) {
                listOfDrivers = res;
            } else {
                console.log(err);
            }

            var numDrivers = listOfDrivers.length;
            for (var i = 0; i < numDrivers; i++) {
                var addressVal = web3.toBigNumber(listOfDrivers[i]);
                $("#drivers").append("<div id='driver" + i + "'class='driver' onclick='fillDriver(" + i + ")'>" + listOfDrivers[i] + " </div>");
            }
        });
    }

    function getAllRides() {
        var ridecount;
        $("#rideCount").empty();
        uberContract.getRideCount(function (err, res) {
            if (!err) {
                ridecount = res;
                $("#rideCount").append("<div id='rideCount2'>" + ridecount + " </div>");
                for (var i = 0; i < ridecount; i++) {
                    var k = i+1;
                    uberContract.getRide(k, function (err, res) {
                        if (!err) {
                            console.log(res);
                            var rideValue2 = web3.fromWei(res[5], 'ether');
                            var status = getStatus(res[6]);

                            $("#getAllRides").append(`<div class="panel-group">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#collapse` + res[0] + `"> Ride` + res[0] + `</a>
                                    </h4>
                            </div>
                            <div id="collapse` + res[0] + `" class="panel-collapse collapse">
                                <div id="panel` + res[0] + `" class="panel-body">
                                    <ul>
                                        <li>Ride Id: ` + res[0] + `</li>
                                        <li>Driver Address: ` + res[1] + `</li>
                                        <li>Rider Address: ` + res[2] + `</li>
                                        <li>Pick Up Address: ` + res[3] + `</li>
                                        <li>Drop off Address: ` + res[4] + `</li>
                                        <li>Ride Value: ` + rideValue2 + ` ether</li>
                                        <li>Ride Status: ` + status + `</li>
                                    </ul>
                                </div>
                            </div>
                            </div>
                            </div>`);
                            if (status == "Requested") {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="payForRide(` + res[0] + `, ` + rideValue2 + `)">Pay for ride</button>`)
                            } else if (status == "Paid" && userAccount == res[1]) {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="startRide(` + res[0] + `)">Start Ride</button>`)
                            }
                            else if ((status == "InProgress") && (userAccount == res[2] || userAccount == res[1])) {
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="completeRide(` + res[0] + `)">Complete</button>`)
                                $("#panel" + res[0]).append(`
                                <button  type="button" class="btn btn-default" onclick="cancelRide(` + res[0] + `)">Cancel</button>`)
                            }
                        } else {
                            console.log(err);
                        }
                    });
                }
            } else {
                console.log(err);
            }
        });
    }

    function events(){
        requestRideEvent.watch(function (error, result) {
            if (!error) {
                alert("fdfd");
                $("#loader").hide();
                rideID = result.args.rideId;
                rideValue = web3.fromWei(result.args.rideValue, 'ether');
                $("#rideid").append(rideID);
                $("#driveraddress").append(result.args.driver);
                $("#rideraddress").append(result.args.rider);
                $("#pickupaddress").append(result.args.pickup);
                $("#dropoffaddress").append(result.args.dropoff);
                $("#rideval").append(rideValue);
                $("#ridestatus").append(getStatus(result.args.status));
            } else {
                $("#loader").hide();
                console.log(error);
            }
        });

         payRideEvent.watch(function (error, result) {
            if (!error) {
                $("#loader").hide();
                $("#ridestatus").empty();
                var status = getStatus(result.args.status);
                $("#ridestatus").append("Status: " + getStatus(status));
            } else {
                $("#loader").hide();
                console.log(error);
            }
        });
    }
    var rideID;
    var rideValue;
    function requestRide() {
        var driver = listOfDrivers[selectedDriver];
        var pickup = $("#addPickUp").val();
        var dropOff = $("#addDropOff").val();
        var distance = $("#addDistance").val();

        uberContract.requestRide(driver, pickup, dropOff, distance, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });

       

    }

    function getStatus(id) {
        var status;
        if (id == 0) {
            status = "NotStarted";
        } else if (id == 1) {
            status = "Requested";
        } else if (id == 2) {
            status = "Paid";
        } else if (id == 3) {
            status = "InProgress";
        } else if (id == 4) {
            status = "Completed";
        } else if (id == 5) {
            status = "Cancelled";
        }
        return status;
    }

    function payForRide(id, value) {
        var weiValue = web3.toWei(web3.toBigNumber(value), 'ether');
        alert(weiValue);
        uberContract.payForRide(id, { value: weiValue }, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });


        
    }

    function startRide(id) {
        uberContract.startRide(id, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });
    }

    function completeRide(id) {
        uberContract.completeRide(id, function (err, res) {
            if (!err)
                console.log(res)
            else
                console.log(err);
        });
    }
    var selectedDriver;
    function fillDriver(id) {
        selectedDriver = id;
        $("#addDriver").val(listOfDrivers[id]);
    }
    window.addEventListener('load', function () {

        if (typeof web3 !== 'undefined') {
            web3js = new Web3(web3.currentProvider);
        } else {

        }
        startApp()
        
    })
</script>