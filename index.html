<!doctype html>
<html>
    <head>
        <title>
            myDapp
        </title>
        <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script language="javascript" src="./dist/web3.min.js"></script>
        <script language="javascript" type="text/javascript" src="/Javascript/uberDriverABI.js"></script>
        <script language="javascript" type="text/javascript" src="/Javascript/uberContract_ABI.js"></script>

    </head>
    <body>
        <h1>Interact with a contract</h1>
            <input type="button" onclick="getAllDriver()" value="Get All Drivers"> 
            <div id="drivers"></div>
        </br>
    <div id="txStatus"></div>
    <div id="accountAddress"></div>
    <div id="addDriversDiv">
        <lablel>Driver</lablel> </br>
        <input type="text" id="addDriver">
        </br>
        <lablel>pickUp</lablel> </br>
        <input type="text" id="addPickUp">
        </br>
        <lablel>Drop Off</lablel> </br>
        <input type="text" id="dropOff">
        </br>
        <lablel>Distance</lablel> </br>
        <input type="text" id="dropOff">
        </br>
        <input type="button" onclick="requestRide()" value="Add Driver"> 
    </div>
        </body>
</html>

<script>
    var uberDrivers;
    var userAccount;
    var uberContract; 

//    var MyContract = web3.eth.contract(uberDriversABI);
    var MyUberContract = web3.eth.contract(uberContractABI);


    function startApp() {
        var uberDriversAddress = "0xf25186b5081ff5ce73482ad761db0eb0d25abfbf";
        var uberContractAddress = "0x345ca3e014aaf5dca488057592ee47305d9b3e10";
        
        //uberDrivers = MyContract.at('0xf25186b5081ff5ce73482ad761db0eb0d25abfbf');
        uberContract = MyUberContract.at('0x2c2b9c9a4a25e24b174f26114e8926a9f2128fe4');

        //uberDrivers = new web3js.eth.contract(uberDriversABI).at(uberDriversAddress);
        //uberContract = new web3js.eth.contract(uberContractABI,uberContractAddress);
        console.log(uberContract);
         var accountInterval = setInterval(function() {
          // Check if account has changed
          if (web3.eth.accounts[0] !== userAccount) {
            userAccount = web3.eth.accounts[0];
            $("#accountAddress").html("Your account: " + userAccount);
          }
        }, 100);


    }
    var listOfDrivers;

    function getAllDriver()
    {
        $("#drivers").empty();
    uberContract.getAllDriver(function (err, res){
        if(!err)
        {
            console.log(res);

            listOfDrivers = res;
        } else         {
            console.log(err);
        }
        
        var numDrivers = listOfDrivers.length;
        for (var i = 0; i < numDrivers; i++) {
            $("#drivers").append("<div id='driver" + i + "'class='driver' onclick='fillDriver(" +listOfDrivers[i] + ")'>" +listOfDrivers[i] + " </div>");
            console.log(listOfDrivers[i]);
        }
    });

   // uberDrivers.getAllDrivers(function(error, result){
   //  if(!error)
   //      console.log(result)
   //  else
   //      console.error(error);
   //  });
    }

    function displayDrivers(ids){
        $("#drivers").empty();
        for(id of ids){
            getDriverDetails(id)
            .then(function(driver){
            $("#drivers").append(`<div class="driver">
              <ul>
                <li>Name: ${driver.name}</li>
                <li>Car: ${driver.car}</li>
                <li>Rating: ${driver.rating}</li>
                <li>Address: ${driver.address}</li>
              </ul>
            </div>`);
            })
        }
    }

    function addDriver(){
        var _name = $("#addName").val();
        var _car = $("#addCar").val();
        
        //return uberDrivers.requestToBeDriver(drivercar, drivername)
        uberDrivers.requestToBeDriver(_car,_name,{gas: 100000000000,gas: 4712388},function(error, result){
            if(!error)
                console.log(result)
            else
                console.error(error);
         });
    }

      function getDriverDetails(id) {
        return uberDrivers.methods.uberdrivers(id);
      }

      function fillDriver(address){
          alert(web3.isAddress(address));
          $("#addDriver").val(address);
      }
     window.addEventListener('load', function() {

        if (typeof web3 !== 'undefined') {
        web3js = new Web3(web3.currentProvider);
        } else {

        }
        startApp()
    })
</script>